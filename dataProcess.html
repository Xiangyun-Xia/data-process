<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>OUT数据处理</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html,body { height: 100%; width: 100%; background: #fff; font-size: 14px; font-family: 'Microsoft Yahei'; background-color: #f1f4f7; }
    input, button, label { outline: none; position: relative; }
    .container { width: 1366px; margin: 0 auto; padding: 20px; }
    .my-input { height: 27px; width: 50px; margin-right: 10px; }
    .my-button { margin-right: 5px; padding: 5px 10px; background: #00b0f0; color: #FFF; border: none; border-radius: 5px; cursor: pointer; }
    .my-button:hover { opacity: 0.9; }
    #file_select { position: absolute; left: 0; top: 0; opacity: 0; font-size: 20px; }
    #file_text{ color: red; }
    .file-type, .file-handle, .max-data { display: flex; align-items: center; margin-top: 10px; }
    h4 { margin: 0 5px; }
    .type-label { margin-right: 10px; }
    input[type="radio"] { margin-right: 3px; }
    .container_export { display: flex; margin-top: 20px; }
    .container_export_result, .container_export_preview { flex: 1; background-color: #f3f4f5; }
    h3 { text-align: center; margin-bottom: 20px; }
    textarea { height: 500px; width: 100%; resize: none; outline: none; padding: 10px; }
    table { text-align: center; border-collapse: collapse; min-width: 650px; background-color: #fff; margin-top: 10px; }
    .hidden_box { display: none }
  </style>
</head>

<body>
  <div class="container">
    <!-- 输入区 -->
    <div class="container_input">
      <label for="file_select" class="file-select">
        <input class="my-button" type="button" id="file_input" value="选择文件">
        <span id="file_text">未选择任何文件</span>
        <input type="file" id="file_select" onchange="fileChange()">
      </label>
      <div class="file-type">
        <h4>数据列数：</h4>
        <label class="type-label"><input name="column" type="radio" value="2" />两列</label> 
        <label><input name="column" type="radio" value="3" checked="checked" />三列</label>
        <h4 style="margin-left: 40px">数据语言：</h4>
        <label class="type-label"><input name="language" type="radio" value="chinese" />中文</label> 
        <label><input name="language" type="radio" value="english" checked="checked" />英文</label>
        <h4 style="margin-left: 40px">显示高程：</h4>
        <label class="type-label"><input name="high" type="radio" value="yes" />是</label> 
        <label><input name="high" type="radio" value="no" checked="checked" />否</label> 
      </div>
      <div class="file-handle">
        <h4>除以</h4>
        <input type="text" id="my_input" class="my-input">
        <button class="my-button" onclick="readFile()">读取文件</button>
        <button class="my-button" onclick="changeData()">转换数据</button>

        <button style="margin-left: 60px" class="my-button" onclick="copyTable('show_table')">复制结果表格</button>
        <button class="my-button" onclick="copyTable('filter_table')">复制筛选表格</button>
        <button class="my-button" onclick="clearData()">清空内容</button>
      </div>
    </div>
    <!-- 输出区 -->
    <div class="container_export">
      <div class="container_export_preview" style="padding-right: 20px">
        <h3>====== 数据输入/原数据预览 ======</h3>
        <textarea name="" id="my_textarea" cols="30" rows="10"></textarea>
        <h3 id="filter_h3" style="margin-top:20px; display: none">====== 结果筛选 ======</h3>
        <table id="filter_table" border="1"></table>
      </div>
      <div class="container_export_result" id="export_result" style="display: none">
        <h3 id="result_h3">====== 结果输出 ======</h3>
        <div class="max-data">
          <h4>MAXIMUM 1-HOUR：</h4>
          <span id="export_span">暂无数据</span>
          <h4 style="margin-left: 50px">MAXIMUM 1-HOUR(处理后)：</h4>
          <span id="export_span_process">暂无数据</span>
        </div>
        <table id="hidden_table" class="hidden_box" border="1"></table>
        <table id="show_table" border="1"></table>
      </div>
    </div>
  </div>
</body>

</html>

<script>
  /**
   * 监听选择文件的改变
   */
  function fileChange() {
    const path = document.getElementById('file_select').value
    const name = path.split('\\')
    document.getElementById('file_text').innerHTML = name[name.length-1]
  }

  /**
   * 转换数据的方法
   */
  function changeData() {
    // 获取用户输入的内容
    const textareaStr = document.getElementById('my_textarea').value
    // 按行切割成数组
    const textareaRow = textareaStr.split(/[\n]/)
    // 处理每一行的数据，按列切割成数组
    const textareaCols = textareaRow.map(row => {
      return row.split(/[\s]/).filter(cols => { return cols !== '' })
    })
    // 获取隐藏表格
    const hiddenTable = document.getElementById('hidden_table')
    hiddenTable.innerHTML = ''
    // 动态添加隐藏表格内容
    for (let i = 0; i < textareaCols.length; i++) {
      const row = textareaCols[i]
      const tr = document.createElement('tr')
      hiddenTable.appendChild(tr)
      for (let j = 0; j < row.length; j++) {
        const td = document.createElement('td')
        tr.appendChild(td)
        td.innerHTML = row[j]
      }
    }
    // 拼接数据
    const rows = hiddenTable.rows
    // 判断数据是两列还是三列
    const statusArr = document.getElementsByName('column')
    const status = statusArr[0].checked ? 2 : 3
    if (status === 2) {
      // 将1和3数据连接，2和4数据连接
      const oddArr = []
      const evenArr = []
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].cells[0]) oddArr.push(rows[i].cells[0].innerHTML)
        if (rows[i].cells[1]) evenArr.push(rows[i].cells[1].innerHTML)
      }
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].cells[2]) oddArr.push(rows[i].cells[2].innerHTML)
        if (rows[i].cells[3]) evenArr.push(rows[i].cells[3].innerHTML)
      }
      // 添加显示表格
      const showTable = document.getElementById('show_table')
      showTable.innerHTML = ''
      // 获取除数
      const divisor = document.getElementById('my_input').value
      //添加表头
      const tr = document.createElement('tr')
      showTable.appendChild(tr)
      const th1 = document.createElement('th')
      tr.appendChild(th1)
      th1.innerHTML = 'DIST(m)'
      const th2 = document.createElement('th')
      tr.appendChild(th2)
      th2.innerHTML = 'MAXIMUM 1-HR CONC(ug/m3)'
      if (divisor) {
        const th3 = document.createElement('th')
        tr.appendChild(th3)
        th3.innerHTML = 'RATE(%)'
      }
      // 动态添加隐藏表格内容
      for (let i = 0; i < oddArr.length; i++) {
        const tr = document.createElement('tr')
        showTable.appendChild(tr)
        const td1 = document.createElement('td')
        tr.appendChild(td1)
        td1.innerHTML = oddArr[i]
        const td2 = document.createElement('td')
        tr.appendChild(td2)
        td2.innerHTML = evenArr[i]
        if (divisor) {
          const td3 = document.createElement('td')
          tr.appendChild(td3)
          td3.innerHTML = Math.round(evenArr[i] / divisor * 10000000000000) / 10000000000000
        }
      }
    } else if (status === 3) {
      // 将1和4数据连接，2和5数据连接，3和6数据连接
      const oneArr = []
      const twoArr = []
      const threeArr = []
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].cells[0]) oneArr.push(rows[i].cells[0].innerHTML)
        if (rows[i].cells[1]) twoArr.push(rows[i].cells[1].innerHTML)
        if (rows[i].cells[2]) threeArr.push(rows[i].cells[2].innerHTML)
      }
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].cells[3]) oneArr.push(rows[i].cells[3].innerHTML)
        if (rows[i].cells[4]) twoArr.push(rows[i].cells[4].innerHTML)
        if (rows[i].cells[5]) threeArr.push(rows[i].cells[5].innerHTML)
      }
      // 添加显示表格
      const showTable = document.getElementById('show_table')
      showTable.innerHTML = ''
      // 获取除数
      const divisor = document.getElementById('my_input').value
      // 获取是否显示高程
      const highArr = document.getElementsByName('high')
      const highFlag = highArr[0].checked ? true : false
      //添加表头
      const tr = document.createElement('tr')
      showTable.appendChild(tr)
      const th1 = document.createElement('th')
      tr.appendChild(th1)
      th1.innerHTML = 'DIST(m)'
      const th2 = document.createElement('th')
      tr.appendChild(th2)
      th2.innerHTML = 'MAXIMUM 1-HR CONC(ug/m3)'
      if (highFlag) {
        const th3 = document.createElement('th')
        tr.appendChild(th3)
        th3.innerHTML = 'RECEPTOR HEIGHT(m)'
      }
      if (divisor) {
        const th4 = document.createElement('th')
        tr.appendChild(th4)
        th4.innerHTML = 'RATE(%)'
      }
      // 动态添加隐藏表格内容
      for (let i = 0; i < oneArr.length; i++) {
        const tr = document.createElement('tr')
        showTable.appendChild(tr)
        const td1 = document.createElement('td')
        tr.appendChild(td1)
        td1.innerHTML = oneArr[i]
        const td2 = document.createElement('td')
        tr.appendChild(td2)
        td2.innerHTML = twoArr[i]
        if (highFlag) {
          const td3 = document.createElement('td')
          tr.appendChild(td3)
          td3.innerHTML = threeArr[i]
        }
        if (divisor) {
          const td4 = document.createElement('td')
          tr.appendChild(td4)
          td4.innerHTML = Math.round(twoArr[i] / divisor * 10000000000000) / 10000000000000
        }
      }
    }

    dataFilter()
  }

  /**
   * 筛选数据的方法
   */
  function dataFilter() {
    const usefulData = [0, 50, 75, 150, 200, 325, 450, 500, 650, 750, 1000, 1200, 1500, 2000, 3000, 4000, 5000]
    // 获取结果的表格
    const showTable = document.getElementById('show_table')
    const filterTable = document.getElementById('filter_table')
    filterTable.innerHTML = ''
    const showTableRows = showTable.rows
    for (let index = 0; index < showTableRows.length; index++) {
      const rows = showTableRows[index]
      const cells = rows.cells
      for (let i = 0; i < usefulData.length; i++) {
        const num = usefulData[i]
        if (index === 0 || num == cells[0].innerHTML) {
          const node = rows.cloneNode(true)
          filterTable.appendChild(node)
          break
        }
      }
    }
    // 显示最大值和筛选表头
    document.getElementById('export_result').style.display = "block"
    document.getElementById('filter_h3').style.display = "block"
    
  }

  /**
   * 读取文件的方法
   */
  function readFile() {
    const objFile = document.getElementById('file_select')
    if(objFile.value === '') {
      alert('请选择文件！')
      return
    }
    // 获取文件
    const files = objFile.files
    // 新建一个FileReader
    const reader = new FileReader()
    // 判断文件是中文还是英文
    const languageArr = document.getElementsByName('language')
    const language = languageArr[0].checked ? 'chinese' : 'english'
    const languageFlag = language === 'chinese' ? true : false
    // 读取文件
    if (languageFlag) {
      console.log('中文')
      reader.readAsText(files[0], 'GB2312')
    } else {
      console.log('英文')
      reader.readAsText(files[0], 'UTF-8')
    }
    // 读取完文件之后会回来这里
    reader.onload = function(e){
      // 读取文件内容
      const fileString = e.target.result
      // 获取 MAXIMUM 1-HOUR 的值
      const a = fileString.indexOf('----------  ----------  ----------  ----------  ----------')
      const b = languageFlag ? fileString.indexOf('最大浓度点离源的距离') : fileString.indexOf('DISTANCE FROM SOURCE')
      const MAXIMUM = fileString.slice(a, b).replace(/-/g, '').split(/[\s]/).filter(item => { return item !== '' })
      // 找到数据的位置
      const statusArr = document.getElementsByName('column')
      const begin = statusArr[0].checked ? fileString.indexOf('---------------------               ---------------------') 
      : fileString.indexOf('----------------------------          -----------------------------')
      const end = languageFlag ? fileString.indexOf('AERSCREEN 最大浓度计算结果 小 结') : fileString.indexOf('AERSCREEN MAXIMUM IMPACT SUMMARY')
      if (end === -1) {
        alert('请确认文件语言是否正确！')
        return
      }
      // 填充 MAXIMUM 1-HOUR 的值
      const span1 = document.getElementById('export_span')
      const span2 = document.getElementById('export_span_process')
      const divisor = document.getElementById('my_input').value || 1
      console.log(divisor, 'divisor')
      span1.innerHTML = languageFlag ? MAXIMUM[1] : MAXIMUM[2]
      span2.innerHTML = languageFlag ? (Math.round(MAXIMUM[1] / divisor * 10000000000000) / 10000000000000) : (Math.round(MAXIMUM[2] / divisor * 10000000000000) / 10000000000000)
      // 获取数据
      const effectiveStr = fileString.slice(begin, end).replace(/-0/g, '&').replace(/\*/g, '').replace(/-/g, '').replace(/&/g, '-0')
      // 将数据添加到textarea中并转换
      document.getElementById('my_textarea').value = effectiveStr
      changeData()
    }
  }

  /**
   * 复制表格的方法
   */
   function copyTable(tableName) {
    console.log(tableName, 'tableName')
    const table = document.getElementById(tableName)
    const range = document.createRange()
    // 设定range包含的节点对象 
    range.selectNode(table)
    // 窗口的selection对象，表示用户选择的文本
    const selection = window.getSelection()
    // 将已经包含的已选择的对象清除掉
    if (selection.rangeCount > 0) selection.removeAllRanges()
    // 将要复制的区域的range对象添加到selection对象中
    selection.addRange(range)
    // 执行copy命令，copy用户选择的文本
    document.execCommand('copy')
  }

  /**
   * 清空数据的方法
   */
  function clearData () {
    window.location.reload(true)
  }
</script>
